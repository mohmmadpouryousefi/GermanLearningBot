from telegram import Update, ReplyKeyboardMarkup, InlineKeyboardButton, InlineKeyboardMarkup
from telegram.ext import ApplicationBuilder, CommandHandler, MessageHandler, filters, ContextTypes
from openrouter_api import ask_openrouter
from db import save_message, get_conversation_history

# ======= CONFIGURATION ========
TELEGRAM_BOT_TOKEN = "7923002260:AAHzDXUqYdrarHjFHHOIRyY7GVj9SyO3_jE"

# ======= START COMMAND ========
async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_id = update.message.from_user.id

    # Ù…Ø±Ø­Ù„Û€ Ø§ÙˆÙ„: Ø§Ù†ØªØ®Ø§Ø¨ Ø³Ø·Ø­ Ø²Ø¨Ø§Ù†
    keyboard = [
        ["ğŸŸ¢ A1 - AnfÃ¤nger", "ğŸŸ¡ A2 - AnfÃ¤nger"],
        ["ğŸŸ  B1 - Mittelstufe", "ğŸ”µ B2 - Mittelstufe"],
        ["ğŸŸ£ C1 - Fortgeschritten", "âš« C2 - Meister"]
    ]
    reply_markup = ReplyKeyboardMarkup(keyboard, one_time_keyboard=True, resize_keyboard=True)

    await update.message.reply_text(
        "Willkommen beim Deutsch-Lernbot! ğŸ‰\n"
        "Bitte wÃ¤hle dein Niveau (Ø³Ø·Ø­ Ø®ÙˆØ¯ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†):",
        reply_markup=reply_markup
    )

    # Save initial state (waiting for level choice)
    context.user_data['state'] = 'choose_level'

# ======= CHAT HANDLER ========
async def chat_with_ai(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_id = update.message.from_user.id
    user_message = update.message.text.strip()

    # Ø§Ú¯Ø± Ù‡Ù†ÙˆØ² Ø³Ø·Ø­ Ø§Ù†ØªØ®Ø§Ø¨ Ù†Ø´Ø¯Ù‡ Ø§Ø³ØªØŒ Ù…Ù†ØªØ¸Ø± Ø§Ù†ØªØ®Ø§Ø¨ Ø³Ø·Ø­ Ú©Ø§Ø±Ø¨Ø± Ù‡Ø³ØªÛŒÙ…
    if context.user_data.get('state') == 'choose_level':
        context.user_data['level'] = user_message  # Ø°Ø®ÛŒØ±Ù‡ Ø³Ø·Ø­ Ø§Ù†ØªØ®Ø§Ø¨ÛŒ
        context.user_data['state'] = 'chat'
        
        # Ù†Ù…Ø§ÛŒØ´ Ù¾ÛŒØ§Ù… Ø¨Ø±Ø§ÛŒ Ø§Ù†ØªØ®Ø§Ø¨ Ù†ÙˆØ¹ ØªÙ…Ø±ÛŒÙ†
        keyboard = [
            ["1. Konversation (Ù…Ú©Ø§Ù„Ù…Ù‡)", "2. Vokabeln (Ù„ØºØ§Øª)"],
            ["3. Quiz (Ø¢Ø²Ù…ÙˆÙ†)"]
        ]
        reply_markup = ReplyKeyboardMarkup(keyboard, one_time_keyboard=True, resize_keyboard=True)
        
        await update.message.reply_text(
            f"Du hast {user_message} gewÃ¤hlt. (Ø´Ù…Ø§ Ø³Ø·Ø­ {user_message} Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ø±Ø¯ÛŒØ¯)\n"
            "Was mÃ¶chtest du jetzt Ã¼ben?\n"
            "1. Konversation (Ù…Ú©Ø§Ù„Ù…Ù‡)\n"
            "2. Vokabeln (Ù„ØºØ§Øª)\n"
            "3. Quiz (Ø¢Ø²Ù…ÙˆÙ†)",
            reply_markup=reply_markup
        )
        return

    # Ø§Ø¯Ø§Ù…Ù‡ Ù…Ú©Ø§Ù„Ù…Ù‡ Ø¨Ø§ ØªÙˆØ¬Ù‡ Ø¨Ù‡ Ø³Ø·Ø­ Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ø¯Ù‡
    user_level = context.user_data.get('level', 'ğŸŸ¢ A1 - AnfÃ¤nger')  # Ø§Ú¯Ø± Ø³Ø·Ø­ Ø§Ù†ØªØ®Ø§Ø¨ Ù†Ø´Ø¯Ù‡ Ø¨Ø§Ø´Ø¯ØŒ A1 Ù¾ÛŒØ´ÙØ±Ø¶ Ø§Ø³Øª
    history = get_conversation_history(user_id)
    messages = [
        {"role": "system", "content": f"Du bist ein Deutschlehrer auf {user_level} Niveau. Sprich nur Deutsch. Ãœbersetze alles ins Persische (ÙØ§Ø±Ø³ÛŒ)."}  # Update system message to request Persian translation
    ] + history + [{"role": "user", "content": user_message}]

    # Ø¯Ø±ÛŒØ§ÙØª Ù¾Ø§Ø³Ø® Ø§Ø² OpenRouter
    ai_reply = ask_openrouter(messages)

    # Ø°Ø®ÛŒØ±Ù‡ Ù¾ÛŒØ§Ù… Ø¯Ø± Ø¯ÛŒØªØ§Ø¨ÛŒØ³
    save_message(user_id, "user", user_message)
    save_message(user_id, "assistant", ai_reply)

    await update.message.reply_text(ai_reply)

# ======= MAIN FUNCTION TO RUN BOT ========
def main():
    # Initialize the database
    init_db()  # Make sure the database and table are created before running the bot

    app = ApplicationBuilder().token(TELEGRAM_BOT_TOKEN).build()

    app.add_handler(CommandHandler("start", start))
    app.add_handler(MessageHandler(filters.TEXT, chat_with_ai))

    print("âœ… Bot is running...")
    app.run_polling()

if __name__ == '__main__':
    main()
